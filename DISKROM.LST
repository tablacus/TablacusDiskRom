                                ;*** AILZ80ASM *** Z-80 Assembler, version 1.0.0.0, LST:Full:4
                                ;   Tablacus DISK ROM for MSX
                                ;   Programmed by
                                ;   Gaku (Lovers/Tablacus)
                                ;
                                ;   ■アセンブル時にROMのタイプを指定する1
                                ;   ASCII-8K/Konami-8Kの場合
                                ;   FIX_ROM_MODE    EQU 01FH
                                ;   ASCII-16Kの場合
                                ;   FIX_ROM_MODE    EQU 03FH
                                ;
                                ;   ■アセンブル時にROMのタイプを指定する2
                                ;   ASCII-8K/ASCII-16Kの場合
                                ;   FIX_ROM_SEL EQU high BANK2_SEL
                                ;   Konami-8Kの場合
                                ;   FIX_ROM_SEL EQU high KONAMI_BANK2_SEL
                                ;
                                ;   ■アセンブル時にドライブAのFDDのサイズを指定する(Bドライブも使用する場合)
                                ;   2DDの場合
       002E                         FIX_DRIVE   EQU 720/16+1
                                ;
                                
                                    INCLUDE "MSXDEF.ASM"
                                
                                ;   LSX-Dodgers DEF
                                ;   MSX
                                
       4000                     RUN EQU 04000H
                                
       000C                     _RDSLT  EQU 0000CH
       0014                     _WRSLT  EQU 00014H
       001C                     _CALSLT EQU 0001CH
       0024                     _ENASLT EQU 00024H
       0030                     _CALLF  EQU 00030H
                                
       009F                     CHGET   EQU 0009FH
       00A2                     CHPUT   EQU 000A2H
       0138                     RSLREG  EQU 00138H
                                
       F38C                     CLPRIM  EQU 0F38CH
       FB03                     RSTMP   EQU 0FB03H
       FB21                     DRVTBL  EQU 0FB21H
       FCC1                     EXPTBL  EQU 0FCC1H
                                
                                            ;ASCII-8K
       6000                     BANK0_SEL EQU   06000H
       6800                     BANK1_SEL EQU   06800H
       7000                     BANK2_SEL EQU   07000H
       7800                     BANK3_SEL EQU   07800H
                                            ;ASCII-16K
                                ;BANK0_SEL EQU 06000H
                                ;BANK1_SEL EQU 07000H
                                            ;KONAMI-8K
       8000                     KONAMI_BANK2_SEL EQU    08000H
       A000                     KONAMI_BANK3_SEL EQU    0A000H
                                
       FB03                     ISC EQU RSTMP
[EOF:MSXDEF.ASM:UTF_8]
                                
000000 4000                         ORG RUN
                                
                                ; MSX ROM header
000000 4000 4142                    DB  "AB"   ; ID for auto-executable ROM
000002 4002 0041                    DW  INIT_ROM   ; Main program execution address.
000004 4004 0000                    DW  0      ; STATEMENT
000006 4006 0000                    DW  0      ; DEVICE
000008 4008 0000                    DW  0      ; TEXT
00000A 400A 000000000000            DW  0,0,0  ; Reserved
                                
000010 4010 C36F42          10      JP  DISKIO
000013 4013 C3A942          10      JP  DSKCHG
000016 4016 C3CF42          10      JP  GETDPB
000019 4019 C32844          10      JP  CHOICE
00001C 401C C32C44          10      JP  DSKFMT
00001F 401F C32E44          10      JP  DSKSTP
                                ;   JP  BASENT
                                ;   SCF
                                ;   JP  DSKFMT
                                ;   JP  DSKSTP
                                ;   NOP
                                ;   JP  GETSLT
                                ;   LD  HL,(0F34BH)
                                ;   RET
                                
00007F 407F                         ORG 0407FH
00007F 407F C9              10      RET
                                ; Version
000080 4080 5461626C61637573        DB  "Tablacus DISK ROM v0.1.0.0",0
            204449534B20524F    
            4D2076302E312E30    
            2E3000              
                                
0000FF 40FF                         ORG 040FFH
0000FF 40FF C9              10      RET
                                
                                    INCLUDE "MSXINIT.ASM"
                                
                                ;   Tablacus DISK ROM - INIT
                                ;
                                
       4100                     INIT_ROM:
000100 4100 3A90F3          13      LD  A,(CLPRIM+4)    ;一時的にインタースロットコールをフックしてる？
000103 4103 FE03             7      CP  low ISC
000105 4105 C8              11      RET Z
                                
000106 4106 21E741          10      LD  HL,AT_ISC
000109 4109 1103FB          10      LD  DE,ISC
00010C 410C 011D00          10      LD  BC,ISC_E-ISC
00010F 410F EDB0                    LDIR
                                
000111 4111 CDCB41          17      CALL    GTSL1_
000114 4114 321CFB          13      LD  (ROM_SLT),A
000117 4117 3E70             7      LD  A,high BANK2_SEL
000119 4119 321EFB          13      LD  (ROM_SEL),A
00011C 411C 3E1F             7      LD  A,01FH
00011E 411E 321DFB          13      LD  (ROM_MODE),A
                                
000121 4121 1E00             7      LD  E,0
000123 4123 3A1CFB          13      LD  A,(ROM_SLT)
000126 4126 210068          10      LD  HL,BANK1_SEL
000129 4129 CD1400          17      CALL    _WRSLT
                                
00012C 412C 210060          10      LD  HL,06000H
00012F 412F 3A1CFB          13      LD  A,(ROM_SLT)
000132 4132 CD0C00          17      CALL    _RDSLT
000135 4135 FE41             7      CP  'A'
000137 4137 2807            12      JR  Z,ROM8K
                                                ;ASCII-8K/Konami-8Kではない(ASCII-16K)
000139 4139 3E3F             7      LD  A,03FH
00013B 413B 321DFB          13      LD  (ROM_MODE),A
00013E 413E 1828            12      JR  ROMCHECKED
       4140                     ROM8K:              ;Konami-8Kチェック
000140 4140 1E01             7      LD  E,1
000142 4142 3A1CFB          13      LD  A,(ROM_SLT)
000145 4145 210070          10      LD  HL,BANK2_SEL
000148 4148 CD1400          17      CALL    _WRSLT
                                
00014B 414B 1E00             7      LD  E,0
00014D 414D 3A1CFB          13      LD  A,(ROM_SLT)
000150 4150 210080          10      LD  HL,KONAMI_BANK2_SEL
000153 4153 CD1400          17      CALL    _WRSLT
                                
000156 4156 210080          10      LD  HL,08000H
000159 4159 3A1CFB          13      LD  A,(ROM_SLT)
00015C 415C CD0C00          17      CALL    _RDSLT
00015F 415F FE41             7      CP  'A'
000161 4161 2005            12      JR  NZ,ROMCHECKED
                                                ;Konami-8K
000163 4163 3E80             7      LD  A,high KONAMI_BANK2_SEL
000165 4165 321EFB          13      LD  (ROM_SEL),A
       4168                     ROMCHECKED:
000168 4168 AF               4      XOR A
000169 4169 6F               4      LD  L,A
00016A 416A 67               4      LD  H,A
00016B 416B CD4344          17      CALL    MAPPING1
00016E 416E 3A1CFB          13      LD  A,(ROM_SLT)
000171 4171 CD1400          17      CALL    _WRSLT
                                
000174 4174 211480          10      LD  HL,08000H+20        ;BPB_TotSec16   
000177 4177 3A1CFB          13      LD  A,(ROM_SLT)
00017A 417A CD0C00          17      CALL    _RDSLT
00017D 417D F5              11      PUSH    AF
00017E 417E 211380          10      LD  HL,08000H+19        ;BPB_TotSec16   
000181 4181 3A1CFB          13      LD  A,(ROM_SLT)
000184 4184 CD0C00          17      CALL    _RDSLT
000187 4187 E1              10      POP HL
                                                    ;HA=TotSec16
000188 4188 6F               4      LD  L,A         ;切り上げ
000189 4189 011F00          10      LD  BC,0001FH
00018C 418C 09              11      ADD HL,BC
00018D 418D 7D               4      LD  A,L
                                
00018E 418E 0605             7      LD  B,5
       4190                     B_DRIVE1:
000190 4190 CB3C             8      SRL H
000192 4192 1F               4      RRA
000193 4193 10FB            13      DJNZ    B_DRIVE1
                                
000195 4195 3C               4      INC A           ;A=(TotSec16/32)+1
000196 4196 321FFB          13      LD  (B_DRIVE),A
                                
                                #if exists FIX_ROM_MODE
                                    LD  A,(ROM_MODE)
                                    CP  FIX_ROM_MODE
                                    JR  Z,OK_FIX_ROM_MODE
                                    LD  HL,MSG_ERROR_ROM_MODE
                                    CALL    MSX
                                    LD  A,(ROM_MODE)
                                    CALL    PRTHX
                                    LD  IY,(EXPTBL) ;メインROMスロット
                                    LD  IX,CHGET
                                    CALL    _CALSLT
                                    LD  HL,MSG_CRLF
                                    CALL    MSX
                                OK_FIX_ROM_MODE:
                                #endif
                                
                                #if exists FIX_ROM_SEL
                                    LD  A,(ROM_SEL)
                                    CP  FIX_ROM_SEL
                                    JR  Z,OK_FIX_ROM_SEL
                                    LD  HL,MSG_ERROR_ROM_SEL
                                    CALL    MSX
                                    LD  A,(ROM_SEL)
                                    CALL    PRTHX
                                    LD  IY,(EXPTBL) ;メインROMスロット
                                    LD  IX,CHGET
                                    CALL    _CALSLT
                                    LD  HL,MSG_CRLF
                                    CALL    MSX
                                OK_FIX_ROM_SEL:
                                #endif
                                
                                #if exists FIX_DRIVE
000199 4199 3A1FFB          13      LD  A,(B_DRIVE)
00019C 419C FE2E             7      CP  FIX_DRIVE
00019E 419E 281D            12      JR  Z,OK_FIX_DRIVE
0001A0 41A0 215A42          10      LD  HL,MSG_ERROR_DRIVE
0001A3 41A3 CD0742          17      CALL    MSX
0001A6 41A6 3A1FFB          13      LD  A,(B_DRIVE)
0001A9 41A9 CD0D42          17      CALL    PRTHX
0001AC 41AC FD2AC1FC        20      LD  IY,(EXPTBL) ;メインROMスロット
0001B0 41B0 DD219F00        14      LD  IX,CHGET
0001B4 41B4 CD1C00          17      CALL    _CALSLT
0001B7 41B7 216942          10      LD  HL,MSG_CRLF
0001BA 41BA CD0742          17      CALL    MSX
       41BD                     OK_FIX_DRIVE:
                                #endif
                                
0001BD 41BD 2103FB          10      LD  HL,ISC
0001C0 41C0 2290F3          16      LD  (CLPRIM+4),HL   ;一時的にインタースロットコールをフックする
0001C3 41C3 DD21CA41        14      LD  IX,INIT1
0001C7 41C7 C303FB          10      JP  ISC
       41CA                     INIT1:
0001CA 41CA C9              10      RET
                                
       41CB                     GTSL1_:             ;自分のいるスロットを知る
0001CB 41CB CD3801          17      CALL    RSLREG      ;read primary slot #
0001CE 41CE 0F               4      RRCA
0001CF 41CF 0F               4      RRCA
0001D0 41D0 E603             7      AND 3       ;[A]=000000PP
0001D2 41D2 5F               4      LD  E,A     ;[E]=000000PP
0001D3 41D3 21C1FC          10      LD  HL,EXPTBL
0001D6 41D6 85               4      ADD A,L     ;桁上りは無い
0001D7 41D7 6F               4      LD  L,A     ;[HL]=EXPTBL+000000PP
0001D8 41D8 7B               4      LD  A,E     ;[A]=000000PP
0001D9 41D9 CB7E            13      BIT 7,(HL)
0001DB 41DB C8              11      RET Z
0001DC 41DC 7D               4      LD  A,L     ;point to SLTTBL entry
0001DD 41DD C604             7      ADD A,4     ;桁上りは無い
0001DF 41DF 6F               4      LD  L,A
0001E0 41E0 7E               7      LD  A,(HL)      ;get currently expansion slot register
0001E1 41E1 E60C             7      AND 00CH        ;[A] = 0000SS00
0001E3 41E3 B3               4      OR  E       ;[A] = 0000SSPP
0001E4 41E4 F680             7      OR  080H        ;[A] = 1000SSPP
0001E6 41E6 C9              10      RET
                                
       41E7                     AT_ISC:
0001E7 FB03                         ORG ISC,AT_ISC-RUN
0001E7 FB03 F5              11      PUSH    AF
0001E8 FB04 E5              11      PUSH    HL
0001E9 FB05 2122FB          10      LD  HL,DRVTBL+1
0001EC FB08 7E               7      LD  A,(HL)
0001ED FB09 B7               4      OR  A       ;DRVTBLのスロットが使われるまで待つ
0001EE FB0A 280A            12      JR  Z,ISC_DEF
0001F0 FB0C 3A1CFB          13      LD  A,(ROM_SLT) ;DRVTBLのスロットをTablacus DISK ROMに置き換える
0001F3 FB0F 77               7      LD  (HL),A
0001F4 FB10 2198F3          10      LD  HL,CLPRIM+12    ;インタースロットコールのフックを元に戻す
0001F7 FB13 2290F3          16      LD  (CLPRIM+4),HL
       FB16                     ISC_DEF:
0001FA FB16 E1              10      POP HL
0001FB FB17 F1              10      POP AF
0001FC FB18 DDE9             8      JP  (IX)
                                
0001FE FB1A                         DS  2
       FB1C                     ROM_SLT:
000200 FB1C 00                      DB  0
       FB1D                     ROM_MODE:
000201 FB1D 00                      DB  0
       FB1E                     ROM_SEL:
000202 FB1E 00                      DB  0
       FB1F                     B_DRIVE:
000203 FB1F 00                      DB  0
       FB20                     ISC_E:
000204 4204                         ORG $$+RUN          ;$DEPHASE
                                
       4204                     MSX1:
000204 4204 CD1942          17      CALL    MSGA1
       4207                     MSX:
000207 4207 7E               7      LD  A,(HL)
000208 4208 23               6      INC HL
000209 4209 B7               4      OR  A
00020A 420A 20F8            12      JR  NZ,MSX1
00020C 420C C9              10      RET
                                
       420D                     PRTHX:
00020D 420D F5              11      PUSH    AF
00020E 420E 07               4      RLCA
00020F 420F 07               4      RLCA
000210 4210 07               4      RLCA
000211 4211 07               4      RLCA
000212 4212 CD1642          17      CALL    PRTA2
000215 4215 F1              10      POP AF
       4216                     PRTA2:
000216 4216 CD2D42          17      CALL    ASC
       4219                     MSGA1:
000219 4219 F5              11      PUSH    AF
00021A 421A C5              11      PUSH    BC
00021B 421B D5              11      PUSH    DE
00021C 421C E5              11      PUSH    HL
00021D 421D FD2AC1FC        20      LD  IY,(EXPTBL) ;メインROMスロット
000221 4221 DD21A200        14      LD  IX,CHPUT
000225 4225 CD1C00          17      CALL    _CALSLT
000228 4228 E1              10      POP HL
000229 4229 D1              10      POP DE
00022A 422A C1              10      POP BC
       422B                     MSGA2:
00022B 422B F1              10      POP AF
00022C 422C C9              10      RET
       422D                     ASC:
00022D 422D E60F             7      AND $0F
00022F 422F F630             7      OR  $30
000231 4231 FE3A             7      CP  $3A
000233 4233 D8              11      RET C
000234 4234 C607             7      ADD A,7
000236 4236 C9              10      RET
                                    
       4237                     MSG_ERROR_ROM_MODE:
000237 4237 496C6C6567616C20        DB  "Illegal ROM_MODE:",0
            524F4D5F4D4F4445    
            3A00                
       4249                     MSG_ERROR_ROM_SEL:
000249 4249 496C6C6567616C20        DB  "Illegal ROM_SEL:",0
            524F4D5F53454C3A    
            00                  
       425A                     MSG_ERROR_DRIVE:
00025A 425A 496C6C6567616C20        DB  "Illegal DRIVE:",0
            44524956453A00      
       4269                     MSG_CRLF:
000269 4269 0D0A00                  DB  13,10,0
[EOF:MSXINIT.ASM:UTF_8]
                                    INCLUDE "MSXDISK.ASM"
                                
                                ;   Tablacus DISK ROM - DISK
                                
                                ;   ROM DISK DRIVER
                                ;   1セクタ512
                                
       426C                     ERROR_WRITE_PROTECTED:
00026C 426C 3E00             7      LD  A,0     ;Write protected
00026E 426E C9              10      RET
       426F                     DISKIO:
00026F 426F 38FB            12      JR  C,ERROR_WRITE_PROTECTED
000271 4271 48               4      LD  C,B
000272 4272 E5              11      PUSH    HL
       4273                     DISKIO1:
000273 4273 C5              11      PUSH    BC
000274 4274 D5              11      PUSH    DE
000275 4275 F5              11      PUSH    AF      ;A=DRIVE
                                
000276 4276 E5              11      PUSH    HL
000277 4277 CD3344          17      CALL    MAPPING
00027A 427A E1              10      POP HL      ;HLは読み出し先のメモリアドレス
                                
                                #if exists FIX_ROM_MODE
                                    LD  A,FIX_ROM_MODE
                                #else
00027B 427B 3A1DFB          13      LD  A,(ROM_MODE)    ;セグメントのサイズでフィルタする(8K:1F/16K:3F)
00027E 427E E63F             7      AND 03FH
                                #endif
000280 4280 A3               4      AND E
000281 4281 1E00             7      LD  E,0     ;DEはROMディスクから読み出すアドレス
000283 4283 C680             7      ADD A,080H
000285 4285 57               4      LD  D,A
                                
000286 4286 010002          10      LD  BC,00200H   ;BCは読み出すセクタサイズ
                                
000289 4289 EB               4      EX  DE,HL
       428A                     DISKIO2:
00028A 428A C5              11      PUSH    BC
00028B 428B D5              11      PUSH    DE
00028C 428C E5              11      PUSH    HL
00028D 428D 3A22FB          13      LD  A,(DRVTBL+1)
000290 4290 CD0C00          17      CALL    _RDSLT
000293 4293 E1              10      POP HL
000294 4294 D1              10      POP DE
000295 4295 C1              10      POP BC
000296 4296 12               7      LD  (DE),A
000297 4297 13               6      INC DE
000298 4298 EDA1            16      CPI         ;HL=HL+1 BC=BC-1 BCが0の場合にP/V=0
00029A 429A EA8A42          10      JP  PE,DISKIO2
                                
00029D 429D EB               4      EX  DE,HL
00029E 429E F1              10      POP AF
00029F 429F D1              10      POP DE
0002A0 42A0 13               6      INC DE
0002A1 42A1 C1              10      POP BC
0002A2 42A2 10CF            13      DJNZ    DISKIO1
0002A4 42A4 41               4      LD  B,C
                                
0002A5 42A5 E1              10      POP HL
                                
0002A6 42A6 AF               4      XOR A
0002A7 42A7 FB               4      EI
0002A8 42A8 C9              10      RET
                                
       42A9                     DSKCHG:
0002A9 42A9 110000          10      LD  DE,0
0002AC 42AC CD3344          17      CALL    MAPPING
                                
0002AF 42AF 211580          10      LD  HL,08000H+21        ;BPB_Media  
0002B2 42B2 3A22FB          13      LD  A,(DRVTBL+1)
0002B5 42B5 CD0C00          17      CALL    _RDSLT
0002B8 42B8 B7               4      OR  A
0002B9 42B9 2804            12      JR  Z,NOTREADY
0002BB 42BB AF               4      XOR A
0002BC 42BC 0601             7      LD  B,1
0002BE 42BE C9              10      RET
       42BF                     NOTREADY:
0002BF 42BF 3E02             7      LD  A,2
0002C1 42C1 37               4      SCF
0002C2 42C2 C9              10      RET
                                
       42C3                     NO_BPB:
0002C3 42C3 E1              10      POP HL
0002C4 42C4 23               6      INC HL
0002C5 42C5 116144          10      LD  DE,DPB2DD
0002C8 42C8 011200          10      LD  BC,DPB2DD_E-DPB2DD
0002CB 42CB EDB0                    LDIR
0002CD 42CD AF               4      XOR A
0002CE 42CE C9              10      RET
                                
       42CF                     GETDPB:
0002CF 42CF E5              11      PUSH    HL
0002D0 42D0 110000          10      LD  DE,0
0002D3 42D3 CD3344          17      CALL    MAPPING
                                
0002D6 42D6 211580          10      LD  HL,08000H+21        ;BPB_Media  
0002D9 42D9 3A22FB          13      LD  A,(DRVTBL+1)
0002DC 42DC CD0C00          17      CALL    _RDSLT
0002DF 42DF B7               4      OR  A
0002E0 42E0 28E1            12      JR  Z,NO_BPB
0002E2 42E2 DDE1            14      POP IX
0002E4 42E4 DD7701          19      LD  (IX+1),A        ;MEDIA
                                
0002E7 42E7 DDE5            15      PUSH    IX
0002E9 42E9 210B80          10      LD  HL,08000H+11        ;BPB_BytsPerSec 
0002EC 42EC 3A22FB          13      LD  A,(DRVTBL+1)
0002EF 42EF CD0C00          17      CALL    _RDSLT
0002F2 42F2 DDE1            14      POP IX
0002F4 42F4 DD7702          19      LD  (IX+2),A        ;SECSIZ LOW
                                
0002F7 42F7 DDE5            15      PUSH    IX
0002F9 42F9 210C80          10      LD  HL,08000H+12        ;BPB_BytsPerSec 
0002FC 42FC 3A22FB          13      LD  A,(DRVTBL+1)
0002FF 42FF CD0C00          17      CALL    _RDSLT
000302 4302 DDE1            14      POP IX
000304 4304 DD7703          19      LD  (IX+3),A        ;SECSIZ HIGH
                                
000307 4307 87               4      ADD A,A
000308 4308 87               4      ADD A,A
000309 4309 87               4      ADD A,A
00030A 430A 3D               4      DEC A
00030B 430B DD7704          19      LD  (IX+4),A        ;DIRMSK
                                
00030E 430E 06FF             7      LD  B,-1
000310 4310 A7               4      AND A           ;無限ループ阻止
       4311                     GETDPB1:
000311 4311 04               4      INC B
000312 4312 1F               4      RRA
000313 4313 38FC            12      JR  C,GETDPB1
000315 4315 DD7005          19      LD  (IX+5),B        ;DIRSHFT
                                
000318 4318 DDE5            15      PUSH    IX
00031A 431A 210D80          10      LD  HL,08000H+13        ;BPB_SecPerClus 
00031D 431D 3A22FB          13      LD  A,(DRVTBL+1)
000320 4320 CD0C00          17      CALL    _RDSLT
000323 4323 DDE1            14      POP IX
000325 4325 3D               4      DEC A
000326 4326 DD7706          19      LD  (IX+6),A        ;CLUSMSK
                                
000329 4329 A7               4      AND A           ;無限ループ阻止
00032A 432A 06FF             7      LD  B,-1
       432C                     GETDPB2:
00032C 432C 04               4      INC B
00032D 432D 1F               4      RRA
00032E 432E 38FC            12      JR  C,GETDPB2
000330 4330 04               4      INC B
000331 4331 DD7007          19      LD  (IX+7),B        ;CLUSSHFT
                                
000334 4334 DDE5            15      PUSH    IX
000336 4336 210E80          10      LD  HL,08000H+14        ;BPB_RsvdSecCnt 
000339 4339 3A22FB          13      LD  A,(DRVTBL+1)
00033C 433C CD0C00          17      CALL    _RDSLT
00033F 433F DDE1            14      POP IX
000341 4341 DD7708          19      LD  (IX+8),A        ;FIRFAT LOW
                                
000344 4344 DDE5            15      PUSH    IX
000346 4346 210F80          10      LD  HL,08000H+15        ;BPB_RsvdSecCnt 
000349 4349 3A22FB          13      LD  A,(DRVTBL+1)
00034C 434C CD0C00          17      CALL    _RDSLT
00034F 434F DDE1            14      POP IX
000351 4351 DD7709          19      LD  (IX+9),A        ;FIRFAT HIGH
                                
000354 4354 DDE5            15      PUSH    IX
000356 4356 211080          10      LD  HL,08000H+16        ;BPB_NumFATs    
000359 4359 3A22FB          13      LD  A,(DRVTBL+1)
00035C 435C CD0C00          17      CALL    _RDSLT
00035F 435F DDE1            14      POP IX
000361 4361 DD770A          19      LD  (IX+10),A       ;FATCNT
                                
000364 4364 DDE5            15      PUSH    IX
000366 4366 211180          10      LD  HL,08000H+17        ;BPB_RootEntCnt 
000369 4369 3A22FB          13      LD  A,(DRVTBL+1)
00036C 436C CD0C00          17      CALL    _RDSLT
00036F 436F DDE1            14      POP IX
000371 4371 DD770B          19      LD  (IX+11),A       ;FATCNT
                                
000374 4374 DDE5            15      PUSH    IX
000376 4376 211680          10      LD  HL,08000H+22        ;BPB_FATSz16    
000379 4379 3A22FB          13      LD  A,(DRVTBL+1)
00037C 437C CD0C00          17      CALL    _RDSLT
00037F 437F DDE1            14      POP IX
000381 4381 DD7710          19      LD  (IX+16),A       ;FATSIZ
                                
000384 4384 6F               4      LD  L,A         ;FATSIZ
000385 4385 2600             7      LD  H,0
000387 4387 DD7E0A          19      LD  A,(IX+10)       ;FATCNT
       438A                     GETDPB3:
00038A 438A 3D               4      DEC A
00038B 438B 2803            12      JR  Z,GETDPB4
00038D 438D 29              11      ADD HL,HL
00038E 438E 18FA            12      JR  GETDPB3
       4390                     GETDPB4:
000390 4390 DD4E08          19      LD  C,(IX+8)        ;FIRFAT
000393 4393 DD4609          19      LD  B,(IX+9)        ;FIRFAT
000396 4396 09              11      ADD HL,BC
000397 4397 DD7511          19      LD  (IX+17),L       ;FIRDIR
00039A 439A DD7412          19      LD  (IX+18),H       ;FIRDIR
                                
00039D 439D 3E08             7      LD  A,2*4           ;SECSIZ HIGH
00039F 439F DD5E0B          19      LD  E,(IX+11)       ;MAXENT
       43A2                     GETDPB5:
0003A2 43A2 CB3B             8      SRL E
0003A4 43A4 1F               4      RRA
0003A5 43A5 30FB            12      JR  NC,GETDPB5
0003A7 43A7 1600             7      LD  D,0
0003A9 43A9 19              11      ADD HL,DE
0003AA 43AA DD750C          19      LD  (IX+12),L       ;FIRREC
0003AD 43AD DD740D          19      LD  (IX+13),H       ;FIRREC
                                
0003B0 43B0 DDE5            15      PUSH    IX
0003B2 43B2 211480          10      LD  HL,08000H+20        ;BPB_TotSec16   
0003B5 43B5 3A22FB          13      LD  A,(DRVTBL+1)
0003B8 43B8 CD0C00          17      CALL    _RDSLT
0003BB 43BB F5              11      PUSH    AF
0003BC 43BC 211380          10      LD  HL,08000H+19        ;BPB_TotSec16   
0003BF 43BF 3A22FB          13      LD  A,(DRVTBL+1)
0003C2 43C2 CD0C00          17      CALL    _RDSLT
0003C5 43C5 E1              10      POP HL
0003C6 43C6 6F               4      LD  L,A         ;HL=TotSec16
0003C7 43C7 DDE1            14      POP IX
                                
0003C9 43C9 DD4E0C          19      LD  C,(IX+12)       ;FIRREC
0003CC 43CC DD460D          19      LD  B,(IX+13)       ;FIRREC
0003CF 43CF A7               4      AND A
0003D0 43D0 ED42            15      SBC HL,BC
                                
0003D2 43D2 DD7E06          19      LD  A,(IX+6)        ;CLUSMSK
0003D5 43D5 3C               4      INC A
0003D6 43D6 37               4      SCF             ;無限ループ阻止
       43D7                     GETDPB6:
0003D7 43D7 1F               4      RRA
0003D8 43D8 3806            12      JR  C,GETDPB7
0003DA 43DA CB3C             8      SRL H
0003DC 43DC CB1D             8      RR  L
0003DE 43DE 18F7            12      JR  GETDPB6
       43E0                     GETDPB7:
0003E0 43E0 23               6      INC HL
0003E1 43E1 DD750E          19      LD  (IX+14),L       ;MAXCLUS
0003E4 43E4 DD740F          19      LD  (IX+15),H       ;MAXCLUS
                                
                                    ;1セクタが512バイト以上の場合を考慮(2HD/1セクタ1024バイト/1.23MB等)
       43E7                     GETDPBD1:
0003E7 43E7 DD7E03          19      LD  A,(IX+3)        ;SECSIZ HIGH
0003EA 43EA E6FC             7      AND 0FCH
0003EC 43EC C8              11      RET Z
                                
0003ED 43ED DDCB033E        23      SRL (IX+3)          ;SECSIZ HIGH
                                
0003F1 43F1 37               4      SCF
0003F2 43F2 DDCB0616        23      RL  (IX+6)          ;CLUSMSK
                                
0003F6 43F6 DD3407          23      INC (IX+7)          ;CLUSSHFT
                                
0003F9 43F9 DDCB0826        23      SLA (IX+8)          ;FIRFAT LOW
0003FD 43FD DDCB0916        23      RL  (IX+9)          ;FIRFAT HIGH
                                
000401 4401 DDCB1026        23      SLA (IX+16)         ;FATSIZ
                                
000405 4405 DDCB1126        23      SLA (IX+17)         ;FIRDIR
000409 4409 DDCB1216        23      RL  (IX+18)         ;FIRDIR
                                
00040D 440D DD6E11          19      LD  L,(IX+17)       ;FIRDIR
000410 4410 DD6612          19      LD  H,(IX+18)       ;FIRDIR
                                
000413 4413 3E08             7      LD  A,2*4           ;SECSIZ HIGH
000415 4415 DD5E0B          19      LD  E,(IX+11)       ;MAXENT
       4418                     GETDPBD5:
000418 4418 CB3B             8      SRL E
00041A 441A 1F               4      RRA
00041B 441B 30FB            12      JR  NC,GETDPBD5
00041D 441D 1600             7      LD  D,0
00041F 441F 19              11      ADD HL,DE
000420 4420 DD750C          19      LD  (IX+12),L       ;FIRREC
000423 4423 DD740D          19      LD  (IX+13),H       ;FIRREC
                                
000426 4426 18BF            12      JR  GETDPBD1
                                
       4428                     CHOICE:
000428 4428 210000          10      LD  HL,0
00042B 442B C9              10      RET
                                
       442C                     DSKFMT:
00042C 442C AF               4      XOR A
00042D 442D 37               4      SCF
       442E                     DSKSTP:
       442E                     BASENT:
00042E 442E C9              10      RET
                                
       442F                     GETSLT:
00042F 442F 3A22FB          13      LD  A,(DRVTBL+1)
000432 4432 C9              10      RET
                                
       4433                     MAPPING:
000433 4433 EB               4      EX  DE,HL
000434 4434 29              11      ADD HL,HL
000435 4435 E5              11      PUSH    HL  ;あとでDEで受け取る
000436 4436 29              11      ADD HL,HL   ;64KB→32KB
000437 4437 29              11      ADD HL,HL   ;32KB→16KB
000438 4438 CD4344          17      CALL    MAPPING1
00043B 443B 3A22FB          13      LD  A,(DRVTBL+1)
00043E 443E CD1400          17      CALL    _WRSLT
                                
000441 4441 D1              10      POP DE
000442 4442 C9              10      RET
       4443                     MAPPING1:
000443 4443 C5              11      PUSH    BC
000444 4444 3C               4      INC A
000445 4445 47               4      LD  B,A
                                #if exists FIX_ROM_MODE
                                    LD  A,FIX_ROM_MODE
                                #else
000446 4446 3A1DFB          13      LD  A,(ROM_MODE)    ;セグメントのサイズでフィルタする(8K:1F/16K:3F)
                                #endif
000449 4449 E620             7      AND 020H
00044B 444B 4F               4      LD  C,A
00044C 444C 3E01             7      LD  A,1
00044E 444E 05               4      DEC B
00044F 444F 2802            12      JR  Z,SETMAP1
                                #if exists FIX_DRIVE
000451 4451 3E2E             7      LD  A,FIX_DRIVE
                                #else
                                    LD  A,(B_DRIVE)
                                #endif
       4453                     SETMAP1:                ;A=16KB単位でカートリッジ内のディスクが存在する位置を指定
000453 4453 0C               4      INC C
000454 4454 0D               4      DEC C
000455 4455 C1              10      POP BC
000456 4456 2002            12      JR  NZ,ASCII16K1
000458 4458 29              11      ADD HL,HL   ;16KB→8KB  ;ASCII-16Kの場合はこの処理を飛ばす
000459 4459 87               4      ADD A,A
       445A                     ASCII16K1:
00045A 445A 84               4      ADD A,H
00045B 445B 5F               4      LD  E,A
                                #if exists FIX_ROM_SEL
                                    LD  A,FIX_ROM_SEL
                                #else
00045C 445C 3A1EFB          13      LD  A,(ROM_SEL)
                                #endif
00045F 445F 67               4      LD  H,A
000460 4460 C9              10      RET
                                
       4461                     DPB2DD:
000461 4461 F9                      DB  0F9H    ;MEDIA
000462 4462 0002                    DW  00200H  ;SECSIZ
000464 4464 0F                      DB  00FH    ;DIRMSK
000465 4465 04                      DB  004H    ;DIRSHFT
000466 4466 01                      DB  001H    ;CLUSMSK
000467 4467 02                      DB  002H    ;CLUSSHFT
000468 4468 0100                    DW  00001H  ;FIRFAT
00046A 446A 02                      DB  002H    ;FATCNT
00046B 446B 70                      DB  070H    ;MAXENT
00046C 446C 0E00                    DW  0000EH  ;FIRREC
00046E 446E CA02                    DW  002CAH  ;MAXCLUS
000470 4470 03                      DB  003H    ;FATSIZ
000471 4471 0700                    DW  0007H   ;FIRDIR
       4473                     DPB2DD_E:
[EOF:MSXDISK.ASM:UTF_8]
                                
000473 4473                         DS  07FFFH-$
003FFF 7FFF 00                      DB  0
       8000                     LAST_ADR:
                                
                                    END
[EOF:DISKROM.ASM:UTF_8]
