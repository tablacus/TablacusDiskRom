                                ;*** AILZ80ASM *** Z-80 Assembler, version 1.0.0.0, LST:Full:4
                                ;   Tablacus DISK ROM for MSX
                                ;   Programmed by
                                ;   Gaku (Lovers/Tablacus)
                                ;
                                ;   ■アセンブル時にROMのタイプを指定する1
                                ;   ASCII-8K/Konami-8Kの場合
                                ;   FIX_ROM_MODE    EQU 01FH
                                ;   ASCII-16Kの場合
                                ;   FIX_ROM_MODE    EQU 03FH
                                ;
                                ;   ■アセンブル時にROMのタイプを指定する2
                                ;   ASCII-8K/ASCII-16Kの場合
                                ;   FIX_ROM_SEL EQU high BANK2_SEL
                                ;   Konami-8Kの場合
                                ;   FIX_ROM_SEL EQU high KONAMI_BANK2_SEL
                                ;
                                ;   ■アセンブル時にドライブAのFDDのサイズを指定する(Bドライブも使用する場合)
                                ;   2DDの場合
                                ;   FIX_DRIVE   EQU 720/16+1
                                ;
                                
                                    INCLUDE "MSXDEF.ASM"
                                
                                ;   LSX-Dodgers DEF
                                ;   MSX
                                
       4000                     RUN EQU 04000H
                                
       000C                     _RDSLT  EQU 0000CH
       0014                     _WRSLT  EQU 00014H
       001C                     _CALSLT EQU 0001CH
       0024                     _ENASLT EQU 00024H
       0030                     _CALLF  EQU 00030H
                                
       009F                     CHGET   EQU 0009FH
       00A2                     CHPUT   EQU 000A2H
       0138                     RSLREG  EQU 00138H
                                
       F38C                     CLPRIM  EQU 0F38CH
       FB03                     RSTMP   EQU 0FB03H
       FB21                     DRVTBL  EQU 0FB21H
       FCC1                     EXPTBL  EQU 0FCC1H
                                
                                            ;ASCII-8K
       6000                     BANK0_SEL EQU   06000H
       6800                     BANK1_SEL EQU   06800H
       7000                     BANK2_SEL EQU   07000H
       7800                     BANK3_SEL EQU   07800H
                                            ;ASCII-16K
                                ;BANK0_SEL EQU 06000H
                                ;BANK1_SEL EQU 07000H
                                            ;KONAMI-8K
       8000                     KONAMI_BANK2_SEL EQU    08000H
       A000                     KONAMI_BANK3_SEL EQU    0A000H
                                
       FB03                     ISC EQU RSTMP
[EOF:MSXDEF.ASM:UTF_8]
                                
000000 4000                         ORG RUN
                                
                                ; MSX ROM header
000000 4000 4142                    DB  "AB"   ; ID for auto-executable ROM
000002 4002 0041                    DW  INIT_ROM   ; Main program execution address.
000004 4004 0000                    DW  0      ; STATEMENT
000006 4006 0000                    DW  0      ; DEVICE
000008 4008 0000                    DW  0      ; TEXT
00000A 400A 000000000000            DW  0,0,0  ; Reserved
                                
000010 4010 C34B42          10      JP  DISKIO
000013 4013 C38542          10      JP  DSKCHG
000016 4016 C3AB42          10      JP  GETDPB
000019 4019 C30444          10      JP  CHOICE
00001C 401C C30844          10      JP  DSKFMT
00001F 401F C30A44          10      JP  DSKSTP
                                ;   JP  BASENT
                                ;   SCF
                                ;   JP  DSKFMT
                                ;   JP  DSKSTP
                                ;   NOP
                                ;   JP  GETSLT
                                ;   LD  HL,(0F34BH)
                                ;   RET
                                
00007F 407F                         ORG 0407FH
00007F 407F C9              10      RET
                                ; Version
000080 4080 5461626C61637573        DB  "Tablacus DISK ROM v0.1.0.0",0
            204449534B20524F    
            4D2076302E312E30    
            2E3000              
                                
0000FF 40FF                         ORG 040FFH
0000FF 40FF C9              10      RET
                                
                                    INCLUDE "MSXINIT.ASM"
                                
                                ;   Tablacus DISK ROM - INIT
                                ;
                                
       4100                     INIT_ROM:
000100 4100 3A90F3          13      LD  A,(CLPRIM+4)    ;一時的にインタースロットコールをフックしてる？
000103 4103 FE03             7      CP  low ISC
000105 4105 C8              11      RET Z
                                
000106 4106 21C341          10      LD  HL,AT_ISC
000109 4109 1103FB          10      LD  DE,ISC
00010C 410C 011D00          10      LD  BC,ISC_E-ISC
00010F 410F EDB0                    LDIR
                                
000111 4111 CDA741          17      CALL    GTSL1_
000114 4114 321CFB          13      LD  (ROM_SLT),A
000117 4117 3E70             7      LD  A,high BANK2_SEL
000119 4119 321EFB          13      LD  (ROM_SEL),A
00011C 411C 3E1F             7      LD  A,01FH
00011E 411E 321DFB          13      LD  (ROM_MODE),A
                                
000121 4121 1E00             7      LD  E,0
000123 4123 3A1CFB          13      LD  A,(ROM_SLT)
000126 4126 210068          10      LD  HL,BANK1_SEL
000129 4129 CD1400          17      CALL    _WRSLT
                                
00012C 412C 210060          10      LD  HL,06000H
00012F 412F 3A1CFB          13      LD  A,(ROM_SLT)
000132 4132 CD0C00          17      CALL    _RDSLT
000135 4135 FE41             7      CP  'A'
000137 4137 2807            12      JR  Z,ROM8K
                                                ;ASCII-8K/Konami-8Kではない(ASCII-16K)
000139 4139 3E3F             7      LD  A,03FH
00013B 413B 321DFB          13      LD  (ROM_MODE),A
00013E 413E 1828            12      JR  ROMCHECKED
       4140                     ROM8K:              ;Konami-8Kチェック
000140 4140 1E01             7      LD  E,1
000142 4142 3A1CFB          13      LD  A,(ROM_SLT)
000145 4145 210070          10      LD  HL,BANK2_SEL
000148 4148 CD1400          17      CALL    _WRSLT
                                
00014B 414B 1E00             7      LD  E,0
00014D 414D 3A1CFB          13      LD  A,(ROM_SLT)
000150 4150 210080          10      LD  HL,KONAMI_BANK2_SEL
000153 4153 CD1400          17      CALL    _WRSLT
                                
000156 4156 210080          10      LD  HL,08000H
000159 4159 3A1CFB          13      LD  A,(ROM_SLT)
00015C 415C CD0C00          17      CALL    _RDSLT
00015F 415F FE41             7      CP  'A'
000161 4161 2005            12      JR  NZ,ROMCHECKED
                                                ;Konami-8K
000163 4163 3E80             7      LD  A,high KONAMI_BANK2_SEL
000165 4165 321EFB          13      LD  (ROM_SEL),A
       4168                     ROMCHECKED:
000168 4168 AF               4      XOR A
000169 4169 6F               4      LD  L,A
00016A 416A 67               4      LD  H,A
00016B 416B CD1F44          17      CALL    MAPPING1
00016E 416E 3A1CFB          13      LD  A,(ROM_SLT)
000171 4171 CD1400          17      CALL    _WRSLT
                                
000174 4174 211480          10      LD  HL,08000H+20        ;BPB_TotSec16   
000177 4177 3A1CFB          13      LD  A,(ROM_SLT)
00017A 417A CD0C00          17      CALL    _RDSLT
00017D 417D F5              11      PUSH    AF
00017E 417E 211380          10      LD  HL,08000H+19        ;BPB_TotSec16   
000181 4181 3A1CFB          13      LD  A,(ROM_SLT)
000184 4184 CD0C00          17      CALL    _RDSLT
000187 4187 E1              10      POP HL
                                                    ;HA=TotSec16
000188 4188 6F               4      LD  L,A         ;切り上げ
000189 4189 011F00          10      LD  BC,0001FH
00018C 418C 09              11      ADD HL,BC
00018D 418D 7D               4      LD  A,L
                                
00018E 418E 0605             7      LD  B,5
       4190                     B_DRIVE1:
000190 4190 CB3C             8      SRL H
000192 4192 1F               4      RRA
000193 4193 10FB            13      DJNZ    B_DRIVE1
                                
000195 4195 3C               4      INC A           ;A=(TotSec16/32)+1
000196 4196 321FFB          13      LD  (B_DRIVE),A
                                
                                #if exists FIX_ROM_MODE
                                    LD  A,(ROM_MODE)
                                    CP  FIX_ROM_MODE
                                    JR  Z,OK_FIX_ROM_MODE
                                    LD  HL,MSG_ERROR_ROM_MODE
                                    CALL    MSX
                                    LD  A,(ROM_MODE)
                                    CALL    PRTHX
                                    LD  IY,(EXPTBL) ;メインROMスロット
                                    LD  IX,CHGET
                                    CALL    _CALSLT
                                    LD  HL,MSG_CRLF
                                    CALL    MSX
                                OK_FIX_ROM_MODE:
                                #endif
                                
                                #if exists FIX_ROM_SEL
                                    LD  A,(ROM_SEL)
                                    CP  FIX_ROM_SEL
                                    JR  Z,OK_FIX_ROM_SEL
                                    LD  HL,MSG_ERROR_ROM_SEL
                                    CALL    MSX
                                    LD  A,(ROM_SEL)
                                    CALL    PRTHX
                                    LD  IY,(EXPTBL) ;メインROMスロット
                                    LD  IX,CHGET
                                    CALL    _CALSLT
                                    LD  HL,MSG_CRLF
                                    CALL    MSX
                                OK_FIX_ROM_SEL:
                                #endif
                                
                                #if exists FIX_DRIVE
                                    LD  A,(B_DRIVE)
                                    CP  FIX_DRIVE
                                    JR  Z,OK_FIX_DRIVE
                                    LD  HL,MSG_ERROR_DRIVE
                                    CALL    MSX
                                    LD  A,(B_DRIVE)
                                    CALL    PRTHX
                                    LD  IY,(EXPTBL) ;メインROMスロット
                                    LD  IX,CHGET
                                    CALL    _CALSLT
                                    LD  HL,MSG_CRLF
                                    CALL    MSX
                                OK_FIX_DRIVE:
                                #endif
                                
000199 4199 2103FB          10      LD  HL,ISC
00019C 419C 2290F3          16      LD  (CLPRIM+4),HL   ;一時的にインタースロットコールをフックする
00019F 419F DD21A641        14      LD  IX,INIT1
0001A3 41A3 C303FB          10      JP  ISC
       41A6                     INIT1:
0001A6 41A6 C9              10      RET
                                
       41A7                     GTSL1_:             ;自分のいるスロットを知る
0001A7 41A7 CD3801          17      CALL    RSLREG      ;read primary slot #
0001AA 41AA 0F               4      RRCA
0001AB 41AB 0F               4      RRCA
0001AC 41AC E603             7      AND 3       ;[A]=000000PP
0001AE 41AE 5F               4      LD  E,A     ;[E]=000000PP
0001AF 41AF 21C1FC          10      LD  HL,EXPTBL
0001B2 41B2 85               4      ADD A,L     ;桁上りは無い
0001B3 41B3 6F               4      LD  L,A     ;[HL]=EXPTBL+000000PP
0001B4 41B4 7B               4      LD  A,E     ;[A]=000000PP
0001B5 41B5 CB7E            13      BIT 7,(HL)
0001B7 41B7 C8              11      RET Z
0001B8 41B8 7D               4      LD  A,L     ;point to SLTTBL entry
0001B9 41B9 C604             7      ADD A,4     ;桁上りは無い
0001BB 41BB 6F               4      LD  L,A
0001BC 41BC 7E               7      LD  A,(HL)      ;get currently expansion slot register
0001BD 41BD E60C             7      AND 00CH        ;[A] = 0000SS00
0001BF 41BF B3               4      OR  E       ;[A] = 0000SSPP
0001C0 41C0 F680             7      OR  080H        ;[A] = 1000SSPP
0001C2 41C2 C9              10      RET
                                
       41C3                     AT_ISC:
0001C3 FB03                         ORG ISC,AT_ISC-RUN
0001C3 FB03 F5              11      PUSH    AF
0001C4 FB04 E5              11      PUSH    HL
0001C5 FB05 2122FB          10      LD  HL,DRVTBL+1
0001C8 FB08 7E               7      LD  A,(HL)
0001C9 FB09 B7               4      OR  A       ;DRVTBLのスロットが使われるまで待つ
0001CA FB0A 280A            12      JR  Z,ISC_DEF
0001CC FB0C 3A1CFB          13      LD  A,(ROM_SLT) ;DRVTBLのスロットをTablacus DISK ROMに置き換える
0001CF FB0F 77               7      LD  (HL),A
0001D0 FB10 2198F3          10      LD  HL,CLPRIM+12    ;インタースロットコールのフックを元に戻す
0001D3 FB13 2290F3          16      LD  (CLPRIM+4),HL
       FB16                     ISC_DEF:
0001D6 FB16 E1              10      POP HL
0001D7 FB17 F1              10      POP AF
0001D8 FB18 DDE9             8      JP  (IX)
                                
0001DA FB1A                         DS  2
       FB1C                     ROM_SLT:
0001DC FB1C 00                      DB  0
       FB1D                     ROM_MODE:
0001DD FB1D 00                      DB  0
       FB1E                     ROM_SEL:
0001DE FB1E 00                      DB  0
       FB1F                     B_DRIVE:
0001DF FB1F 00                      DB  0
       FB20                     ISC_E:
0001E0 41E0                         ORG $$+RUN          ;$DEPHASE
                                
       41E0                     MSX1:
0001E0 41E0 CDF541          17      CALL    MSGA1
       41E3                     MSX:
0001E3 41E3 7E               7      LD  A,(HL)
0001E4 41E4 23               6      INC HL
0001E5 41E5 B7               4      OR  A
0001E6 41E6 20F8            12      JR  NZ,MSX1
0001E8 41E8 C9              10      RET
                                
       41E9                     PRTHX:
0001E9 41E9 F5              11      PUSH    AF
0001EA 41EA 07               4      RLCA
0001EB 41EB 07               4      RLCA
0001EC 41EC 07               4      RLCA
0001ED 41ED 07               4      RLCA
0001EE 41EE CDF241          17      CALL    PRTA2
0001F1 41F1 F1              10      POP AF
       41F2                     PRTA2:
0001F2 41F2 CD0942          17      CALL    ASC
       41F5                     MSGA1:
0001F5 41F5 F5              11      PUSH    AF
0001F6 41F6 C5              11      PUSH    BC
0001F7 41F7 D5              11      PUSH    DE
0001F8 41F8 E5              11      PUSH    HL
0001F9 41F9 FD2AC1FC        20      LD  IY,(EXPTBL) ;メインROMスロット
0001FD 41FD DD21A200        14      LD  IX,CHPUT
000201 4201 CD1C00          17      CALL    _CALSLT
000204 4204 E1              10      POP HL
000205 4205 D1              10      POP DE
000206 4206 C1              10      POP BC
       4207                     MSGA2:
000207 4207 F1              10      POP AF
000208 4208 C9              10      RET
       4209                     ASC:
000209 4209 E60F             7      AND $0F
00020B 420B F630             7      OR  $30
00020D 420D FE3A             7      CP  $3A
00020F 420F D8              11      RET C
000210 4210 C607             7      ADD A,7
000212 4212 C9              10      RET
                                    
       4213                     MSG_ERROR_ROM_MODE:
000213 4213 496C6C6567616C20        DB  "Illegal ROM_MODE:",0
            524F4D5F4D4F4445    
            3A00                
       4225                     MSG_ERROR_ROM_SEL:
000225 4225 496C6C6567616C20        DB  "Illegal ROM_SEL:",0
            524F4D5F53454C3A    
            00                  
       4236                     MSG_ERROR_DRIVE:
000236 4236 496C6C6567616C20        DB  "Illegal DRIVE:",0
            44524956453A00      
       4245                     MSG_CRLF:
000245 4245 0D0A00                  DB  13,10,0
[EOF:MSXINIT.ASM:UTF_8]
                                    INCLUDE "MSXDISK.ASM"
                                
                                ;   Tablacus DISK ROM - DISK
                                
                                ;   ROM DISK DRIVER
                                ;   1セクタ512
                                
       4248                     ERROR_WRITE_PROTECTED:
000248 4248 3E00             7      LD  A,0     ;Write protected
00024A 424A C9              10      RET
       424B                     DISKIO:
00024B 424B 38FB            12      JR  C,ERROR_WRITE_PROTECTED
00024D 424D 48               4      LD  C,B
00024E 424E E5              11      PUSH    HL
       424F                     DISKIO1:
00024F 424F C5              11      PUSH    BC
000250 4250 D5              11      PUSH    DE
000251 4251 F5              11      PUSH    AF      ;A=DRIVE
                                
000252 4252 E5              11      PUSH    HL
000253 4253 CD0F44          17      CALL    MAPPING
000256 4256 E1              10      POP HL      ;HLは読み出し先のメモリアドレス
                                
                                #if exists FIX_ROM_MODE
                                    LD  A,FIX_ROM_MODE
                                #else
000257 4257 3A1DFB          13      LD  A,(ROM_MODE)    ;セグメントのサイズでフィルタする(8K:1F/16K:3F)
00025A 425A E63F             7      AND 03FH
                                #endif
00025C 425C A3               4      AND E
00025D 425D 1E00             7      LD  E,0     ;DEはROMディスクから読み出すアドレス
00025F 425F C680             7      ADD A,080H
000261 4261 57               4      LD  D,A
                                
000262 4262 010002          10      LD  BC,00200H   ;BCは読み出すセクタサイズ
                                
000265 4265 EB               4      EX  DE,HL
       4266                     DISKIO2:
000266 4266 C5              11      PUSH    BC
000267 4267 D5              11      PUSH    DE
000268 4268 E5              11      PUSH    HL
000269 4269 3A22FB          13      LD  A,(DRVTBL+1)
00026C 426C CD0C00          17      CALL    _RDSLT
00026F 426F E1              10      POP HL
000270 4270 D1              10      POP DE
000271 4271 C1              10      POP BC
000272 4272 12               7      LD  (DE),A
000273 4273 13               6      INC DE
000274 4274 EDA1            16      CPI         ;HL=HL+1 BC=BC-1 BCが0の場合にP/V=0
000276 4276 EA6642          10      JP  PE,DISKIO2
                                
000279 4279 EB               4      EX  DE,HL
00027A 427A F1              10      POP AF
00027B 427B D1              10      POP DE
00027C 427C 13               6      INC DE
00027D 427D C1              10      POP BC
00027E 427E 10CF            13      DJNZ    DISKIO1
000280 4280 41               4      LD  B,C
                                
000281 4281 E1              10      POP HL
                                
000282 4282 AF               4      XOR A
000283 4283 FB               4      EI
000284 4284 C9              10      RET
                                
       4285                     DSKCHG:
000285 4285 110000          10      LD  DE,0
000288 4288 CD0F44          17      CALL    MAPPING
                                
00028B 428B 211580          10      LD  HL,08000H+21        ;BPB_Media  
00028E 428E 3A22FB          13      LD  A,(DRVTBL+1)
000291 4291 CD0C00          17      CALL    _RDSLT
000294 4294 B7               4      OR  A
000295 4295 2804            12      JR  Z,NOTREADY
000297 4297 AF               4      XOR A
000298 4298 0601             7      LD  B,1
00029A 429A C9              10      RET
       429B                     NOTREADY:
00029B 429B 3E02             7      LD  A,2
00029D 429D 37               4      SCF
00029E 429E C9              10      RET
                                
       429F                     NO_BPB:
00029F 429F E1              10      POP HL
0002A0 42A0 23               6      INC HL
0002A1 42A1 113E44          10      LD  DE,DPB2DD
0002A4 42A4 011200          10      LD  BC,DPB2DD_E-DPB2DD
0002A7 42A7 EDB0                    LDIR
0002A9 42A9 AF               4      XOR A
0002AA 42AA C9              10      RET
                                
       42AB                     GETDPB:
0002AB 42AB E5              11      PUSH    HL
0002AC 42AC 110000          10      LD  DE,0
0002AF 42AF CD0F44          17      CALL    MAPPING
                                
0002B2 42B2 211580          10      LD  HL,08000H+21        ;BPB_Media  
0002B5 42B5 3A22FB          13      LD  A,(DRVTBL+1)
0002B8 42B8 CD0C00          17      CALL    _RDSLT
0002BB 42BB B7               4      OR  A
0002BC 42BC 28E1            12      JR  Z,NO_BPB
0002BE 42BE DDE1            14      POP IX
0002C0 42C0 DD7701          19      LD  (IX+1),A        ;MEDIA
                                
0002C3 42C3 DDE5            15      PUSH    IX
0002C5 42C5 210B80          10      LD  HL,08000H+11        ;BPB_BytsPerSec 
0002C8 42C8 3A22FB          13      LD  A,(DRVTBL+1)
0002CB 42CB CD0C00          17      CALL    _RDSLT
0002CE 42CE DDE1            14      POP IX
0002D0 42D0 DD7702          19      LD  (IX+2),A        ;SECSIZ LOW
                                
0002D3 42D3 DDE5            15      PUSH    IX
0002D5 42D5 210C80          10      LD  HL,08000H+12        ;BPB_BytsPerSec 
0002D8 42D8 3A22FB          13      LD  A,(DRVTBL+1)
0002DB 42DB CD0C00          17      CALL    _RDSLT
0002DE 42DE DDE1            14      POP IX
0002E0 42E0 DD7703          19      LD  (IX+3),A        ;SECSIZ HIGH
                                
0002E3 42E3 87               4      ADD A,A
0002E4 42E4 87               4      ADD A,A
0002E5 42E5 87               4      ADD A,A
0002E6 42E6 3D               4      DEC A
0002E7 42E7 DD7704          19      LD  (IX+4),A        ;DIRMSK
                                
0002EA 42EA 06FF             7      LD  B,-1
0002EC 42EC A7               4      AND A           ;無限ループ阻止
       42ED                     GETDPB1:
0002ED 42ED 04               4      INC B
0002EE 42EE 1F               4      RRA
0002EF 42EF 38FC            12      JR  C,GETDPB1
0002F1 42F1 DD7005          19      LD  (IX+5),B        ;DIRSHFT
                                
0002F4 42F4 DDE5            15      PUSH    IX
0002F6 42F6 210D80          10      LD  HL,08000H+13        ;BPB_SecPerClus 
0002F9 42F9 3A22FB          13      LD  A,(DRVTBL+1)
0002FC 42FC CD0C00          17      CALL    _RDSLT
0002FF 42FF DDE1            14      POP IX
000301 4301 3D               4      DEC A
000302 4302 DD7706          19      LD  (IX+6),A        ;CLUSMSK
                                
000305 4305 A7               4      AND A           ;無限ループ阻止
000306 4306 06FF             7      LD  B,-1
       4308                     GETDPB2:
000308 4308 04               4      INC B
000309 4309 1F               4      RRA
00030A 430A 38FC            12      JR  C,GETDPB2
00030C 430C 04               4      INC B
00030D 430D DD7007          19      LD  (IX+7),B        ;CLUSSHFT
                                
000310 4310 DDE5            15      PUSH    IX
000312 4312 210E80          10      LD  HL,08000H+14        ;BPB_RsvdSecCnt 
000315 4315 3A22FB          13      LD  A,(DRVTBL+1)
000318 4318 CD0C00          17      CALL    _RDSLT
00031B 431B DDE1            14      POP IX
00031D 431D DD7708          19      LD  (IX+8),A        ;FIRFAT LOW
                                
000320 4320 DDE5            15      PUSH    IX
000322 4322 210F80          10      LD  HL,08000H+15        ;BPB_RsvdSecCnt 
000325 4325 3A22FB          13      LD  A,(DRVTBL+1)
000328 4328 CD0C00          17      CALL    _RDSLT
00032B 432B DDE1            14      POP IX
00032D 432D DD7709          19      LD  (IX+9),A        ;FIRFAT HIGH
                                
000330 4330 DDE5            15      PUSH    IX
000332 4332 211080          10      LD  HL,08000H+16        ;BPB_NumFATs    
000335 4335 3A22FB          13      LD  A,(DRVTBL+1)
000338 4338 CD0C00          17      CALL    _RDSLT
00033B 433B DDE1            14      POP IX
00033D 433D DD770A          19      LD  (IX+10),A       ;FATCNT
                                
000340 4340 DDE5            15      PUSH    IX
000342 4342 211180          10      LD  HL,08000H+17        ;BPB_RootEntCnt 
000345 4345 3A22FB          13      LD  A,(DRVTBL+1)
000348 4348 CD0C00          17      CALL    _RDSLT
00034B 434B DDE1            14      POP IX
00034D 434D DD770B          19      LD  (IX+11),A       ;FATCNT
                                
000350 4350 DDE5            15      PUSH    IX
000352 4352 211680          10      LD  HL,08000H+22        ;BPB_FATSz16    
000355 4355 3A22FB          13      LD  A,(DRVTBL+1)
000358 4358 CD0C00          17      CALL    _RDSLT
00035B 435B DDE1            14      POP IX
00035D 435D DD7710          19      LD  (IX+16),A       ;FATSIZ
                                
000360 4360 6F               4      LD  L,A         ;FATSIZ
000361 4361 2600             7      LD  H,0
000363 4363 DD7E0A          19      LD  A,(IX+10)       ;FATCNT
       4366                     GETDPB3:
000366 4366 3D               4      DEC A
000367 4367 2803            12      JR  Z,GETDPB4
000369 4369 29              11      ADD HL,HL
00036A 436A 18FA            12      JR  GETDPB3
       436C                     GETDPB4:
00036C 436C DD4E08          19      LD  C,(IX+8)        ;FIRFAT
00036F 436F DD4609          19      LD  B,(IX+9)        ;FIRFAT
000372 4372 09              11      ADD HL,BC
000373 4373 DD7511          19      LD  (IX+17),L       ;FIRDIR
000376 4376 DD7412          19      LD  (IX+18),H       ;FIRDIR
                                
000379 4379 3E08             7      LD  A,2*4           ;SECSIZ HIGH
00037B 437B DD5E0B          19      LD  E,(IX+11)       ;MAXENT
       437E                     GETDPB5:
00037E 437E CB3B             8      SRL E
000380 4380 1F               4      RRA
000381 4381 30FB            12      JR  NC,GETDPB5
000383 4383 1600             7      LD  D,0
000385 4385 19              11      ADD HL,DE
000386 4386 DD750C          19      LD  (IX+12),L       ;FIRREC
000389 4389 DD740D          19      LD  (IX+13),H       ;FIRREC
                                
00038C 438C DDE5            15      PUSH    IX
00038E 438E 211480          10      LD  HL,08000H+20        ;BPB_TotSec16   
000391 4391 3A22FB          13      LD  A,(DRVTBL+1)
000394 4394 CD0C00          17      CALL    _RDSLT
000397 4397 F5              11      PUSH    AF
000398 4398 211380          10      LD  HL,08000H+19        ;BPB_TotSec16   
00039B 439B 3A22FB          13      LD  A,(DRVTBL+1)
00039E 439E CD0C00          17      CALL    _RDSLT
0003A1 43A1 E1              10      POP HL
0003A2 43A2 6F               4      LD  L,A         ;HL=TotSec16
0003A3 43A3 DDE1            14      POP IX
                                
0003A5 43A5 DD4E0C          19      LD  C,(IX+12)       ;FIRREC
0003A8 43A8 DD460D          19      LD  B,(IX+13)       ;FIRREC
0003AB 43AB A7               4      AND A
0003AC 43AC ED42            15      SBC HL,BC
                                
0003AE 43AE DD7E06          19      LD  A,(IX+6)        ;CLUSMSK
0003B1 43B1 3C               4      INC A
0003B2 43B2 37               4      SCF             ;無限ループ阻止
       43B3                     GETDPB6:
0003B3 43B3 1F               4      RRA
0003B4 43B4 3806            12      JR  C,GETDPB7
0003B6 43B6 CB3C             8      SRL H
0003B8 43B8 CB1D             8      RR  L
0003BA 43BA 18F7            12      JR  GETDPB6
       43BC                     GETDPB7:
0003BC 43BC 23               6      INC HL
0003BD 43BD DD750E          19      LD  (IX+14),L       ;MAXCLUS
0003C0 43C0 DD740F          19      LD  (IX+15),H       ;MAXCLUS
                                
                                    ;1セクタが512バイト以上の場合を考慮(2HD/1セクタ1024バイト/1.23MB等)
       43C3                     GETDPBD1:
0003C3 43C3 DD7E03          19      LD  A,(IX+3)        ;SECSIZ HIGH
0003C6 43C6 E6FC             7      AND 0FCH
0003C8 43C8 C8              11      RET Z
                                
0003C9 43C9 DDCB033E        23      SRL (IX+3)          ;SECSIZ HIGH
                                
0003CD 43CD 37               4      SCF
0003CE 43CE DDCB0616        23      RL  (IX+6)          ;CLUSMSK
                                
0003D2 43D2 DD3407          23      INC (IX+7)          ;CLUSSHFT
                                
0003D5 43D5 DDCB0826        23      SLA (IX+8)          ;FIRFAT LOW
0003D9 43D9 DDCB0916        23      RL  (IX+9)          ;FIRFAT HIGH
                                
0003DD 43DD DDCB1026        23      SLA (IX+16)         ;FATSIZ
                                
0003E1 43E1 DDCB1126        23      SLA (IX+17)         ;FIRDIR
0003E5 43E5 DDCB1216        23      RL  (IX+18)         ;FIRDIR
                                
0003E9 43E9 DD6E11          19      LD  L,(IX+17)       ;FIRDIR
0003EC 43EC DD6612          19      LD  H,(IX+18)       ;FIRDIR
                                
0003EF 43EF 3E08             7      LD  A,2*4           ;SECSIZ HIGH
0003F1 43F1 DD5E0B          19      LD  E,(IX+11)       ;MAXENT
       43F4                     GETDPBD5:
0003F4 43F4 CB3B             8      SRL E
0003F6 43F6 1F               4      RRA
0003F7 43F7 30FB            12      JR  NC,GETDPBD5
0003F9 43F9 1600             7      LD  D,0
0003FB 43FB 19              11      ADD HL,DE
0003FC 43FC DD750C          19      LD  (IX+12),L       ;FIRREC
0003FF 43FF DD740D          19      LD  (IX+13),H       ;FIRREC
                                
000402 4402 18BF            12      JR  GETDPBD1
                                
       4404                     CHOICE:
000404 4404 210000          10      LD  HL,0
000407 4407 C9              10      RET
                                
       4408                     DSKFMT:
000408 4408 AF               4      XOR A
000409 4409 37               4      SCF
       440A                     DSKSTP:
       440A                     BASENT:
00040A 440A C9              10      RET
                                
       440B                     GETSLT:
00040B 440B 3A22FB          13      LD  A,(DRVTBL+1)
00040E 440E C9              10      RET
                                
       440F                     MAPPING:
00040F 440F EB               4      EX  DE,HL
000410 4410 29              11      ADD HL,HL
000411 4411 E5              11      PUSH    HL  ;あとでDEで受け取る
000412 4412 29              11      ADD HL,HL   ;64KB→32KB
000413 4413 29              11      ADD HL,HL   ;32KB→16KB
000414 4414 CD1F44          17      CALL    MAPPING1
000417 4417 3A22FB          13      LD  A,(DRVTBL+1)
00041A 441A CD1400          17      CALL    _WRSLT
                                
00041D 441D D1              10      POP DE
00041E 441E C9              10      RET
       441F                     MAPPING1:
00041F 441F C5              11      PUSH    BC
000420 4420 3C               4      INC A
000421 4421 47               4      LD  B,A
                                #if exists FIX_ROM_MODE
                                    LD  A,FIX_ROM_MODE
                                #else
000422 4422 3A1DFB          13      LD  A,(ROM_MODE)    ;セグメントのサイズでフィルタする(8K:1F/16K:3F)
                                #endif
000425 4425 E620             7      AND 020H
000427 4427 4F               4      LD  C,A
000428 4428 3E01             7      LD  A,1
00042A 442A 05               4      DEC B
00042B 442B 2803            12      JR  Z,SETMAP1
                                #if exists FIX_DRIVE
                                    LD  A,FIX_DRIVE
                                #else
00042D 442D 3A1FFB          13      LD  A,(B_DRIVE)
                                #endif
       4430                     SETMAP1:                ;A=16KB単位でカートリッジ内のディスクが存在する位置を指定
000430 4430 0C               4      INC C
000431 4431 0D               4      DEC C
000432 4432 C1              10      POP BC
000433 4433 2002            12      JR  NZ,ASCII16K1
000435 4435 29              11      ADD HL,HL   ;16KB→8KB  ;ASCII-16Kの場合はこの処理を飛ばす
000436 4436 87               4      ADD A,A
       4437                     ASCII16K1:
000437 4437 84               4      ADD A,H
000438 4438 5F               4      LD  E,A
                                #if exists FIX_ROM_SEL
                                    LD  A,FIX_ROM_SEL
                                #else
000439 4439 3A1EFB          13      LD  A,(ROM_SEL)
                                #endif
00043C 443C 67               4      LD  H,A
00043D 443D C9              10      RET
                                
       443E                     DPB2DD:
00043E 443E F9                      DB  0F9H    ;MEDIA
00043F 443F 0002                    DW  00200H  ;SECSIZ
000441 4441 0F                      DB  00FH    ;DIRMSK
000442 4442 04                      DB  004H    ;DIRSHFT
000443 4443 01                      DB  001H    ;CLUSMSK
000444 4444 02                      DB  002H    ;CLUSSHFT
000445 4445 0100                    DW  00001H  ;FIRFAT
000447 4447 02                      DB  002H    ;FATCNT
000448 4448 70                      DB  070H    ;MAXENT
000449 4449 0E00                    DW  0000EH  ;FIRREC
00044B 444B CA02                    DW  002CAH  ;MAXCLUS
00044D 444D 03                      DB  003H    ;FATSIZ
00044E 444E 0700                    DW  0007H   ;FIRDIR
       4450                     DPB2DD_E:
[EOF:MSXDISK.ASM:UTF_8]
                                
000450 4450                         DS  07FFFH-$
003FFF 7FFF 00                      DB  0
       8000                     LAST_ADR:
                                
                                    END
[EOF:DISKROM.ASM:UTF_8]
